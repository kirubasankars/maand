### Maand: A Agentless Job Orchestration Framework

Maand is a lightweight, agentless framework designed for efficient task orchestration across multiple agents within a cluster. It automates job execution, coordinating tasks between agents.

### Key Concepts:

- **Agent**: A Linux machine identified by its IP address and role, as defined in the `agents.json` file.
- **Job**: A directory containing a `manifest.json` file and a `Makefile` with defined targets for job execution.
- **Role**: A label that associates jobs with specific agents. Jobs are assigned to agents based on matching roles in both the `manifest.json` and `agents.json` files, enabling static service discovery.
- **Bucket**: Logical grouping of related jobs for better organization.

Maand uses make file to executing jobs, one can call binaries, Docker commands, Docker Compose tasks, and systemd jobs.

### Prerequisites:

Before using Maand, ensure the following:

- Each agent must have `make` and `rsync` installed.
- SSH keys are required for secure communication between the controller and agents.

### Setting Up Your Project:

1. **Initialize the Project Folder**: To create the necessary project structure, run:

```shell
$ maand init
$ tree
.
├── data
│   ├── agents.db
│   ├── jobs.db
│   ├── kv.db
│   └── maand.db
├── logs
├── maand.conf
├── secrets
│   ├── ca.crt
│   └── ca.key
└── workspace
    ├── agents.json
    ├── command.sh
    ├── secrets.env
    └── variables.env

5 directories, 11 files
```

2. **Configure Agent Information**: Define the IP addresses, SSH user, and SSH key for each agent in the `agents.json` and `maand.conf` files.

**Example `workspace/agents.json`**:

```json
[
  {
    "host": "10.27.221.181"
  },
  {
    "host": "10.27.221.144"
  },
  {
    "host": "10.27.221.170"
  }
]
```

**Example `maand.conf`**:

```text
[default]
ca_ttl = 3650
use_sudo = 1
ssh_user = agent
ssh_key = secrets/homelab.key
```

Ensure your SSH key is placed in the `secrets` folder.

### Verifying Connectivity:

After setup, check agent connectivity by running:

```shell
$ maand build
$ maand uptime
[10.27.221.181]  14:39:54 up  1:06,  1 user,  load average: 0.11, 0.07, 0.01
[10.27.221.170]  14:39:54 up  1:06,  1 user,  load average: 0.03, 0.08, 0.08
[10.27.221.144]  14:39:54 up  1:06,  1 user,  load average: 0.12, 0.05, 0.01
```

This command ensures the agents are connected and provides insights into their system load.

### Running Shell Commands on Agents:

To execute commands on agents, update the `command.sh` file in your workspace. For example, to run `uname -a` on all agents:

```shell
$ maand run_command --no-check
[10.27.221.181] Linux fedora 6.11.8-200.fc40.x86_64 #1 SMP PREEMPT_DYNAMIC Thu Nov 14 20:38:18 UTC 2024 x86_64 GNU/Linux
[10.27.221.144] Linux agent2 6.11.8-200.fc40.x86_64 #1 SMP PREEMPT_DYNAMIC Thu Nov 14 20:38:18 UTC 2024 x86_64 GNU/Linux
[10.27.221.170] Linux agent3 6.11.8-200.fc40.x86_64 #1 SMP PREEMPT_DYNAMIC Thu Nov 14 20:38:18 UTC 2024 x86_64 GNU/Linux
```

### Files Generated by `maand init`

1. **secrets/ca.key** – Private key for the certificate authority.
2. **secrets/ca.crt** – Public certificate for the certificate authority.
3. **logs/*.log** – Log files, one per agent, generated each time a command is run.
4. **data/*.db** – Internal database files used by Maand (SQLite).
5. **workspace/variables.env** – Stores environment variables in key-value pairs.
6. **workspace/secrets.env** – Stores sensitive environment variables that aren't exported to `context.env`.

### Setting Up a Job

To create jobs, add a `jobs` folder inside `workspace`. For each job, create a subfolder (e.g., `sample_job`) containing a `manifest.json` and `Makefile`.

**Example Job Structure**:

```shell
$ tree ./workspace
workspace
└── jobs
    └── sample_job
        └── manifest.json
        └── Makefile
```

**Example `manifest.json`**:

```json
{
  "roles": ["ROLE1"]
}
```

**Example `Makefile`**:

```text
start:
    echo "starting job"
stop:
    echo "stopping job"
restart:
    echo "restarting job"
```

### Understanding `manifest.json`

The `manifest.json` file defines which agents should execute a given job. The job is assigned to agents based on role matches in both the `manifest.json` and `agents.json` files.

### Running Updates

To deploy or update job files on all agents in the `/opt/agent/[bucket_guid]` directory, run:

```shell
$ maand build
$ maand update
```

This command pushes the updated job files to all agents.

### Agent Directory Structure

On each agent, the `/opt/agent/[bucket_guid]` directory will contain:

```shell
$ tree /opt/agent/[bucket_guid]
/opt/agent/[bucket_guid]
├── agent.txt
├── update_seq.txt
├── context.env
├── roles.txt
├── jobs.txt
├── disabled_jobs.txt
├── bin
│   ├── start_jobs.sh
│   ├── stop_jobs.sh
│   └── restart_jobs.sh
├── certs
│   ├── agent.key
│   └── agent.crt
└── jobs
    └── sample_job
        ├── manifest.json
        └── Makefile
```

- **`agent.txt`**: Contains the agent's unique identifier.
- **`update_seq.txt`**: Tracks the update sequence, incremented with each update.
- **`roles.txt`**: Lists the roles assigned to the agent.
- **`jobs.txt`**: Lists the jobs assigned to the agent.
- **`disabled_jobs.txt`**: Lists the jobs disabled for the agent.
- **`certs`**: Contains the agent’s private and public certificates (`agent.key` and `agent.crt`).
- **`jobs`**: Contains job directories with each job's `manifest.json` and `Makefile`.
- **`context.env`**: Environment variables set by Maand.

The update command also renews agent and job certificates if they expire within 15 days or when configuration changes occur.

### Variable Substitution

**Maand** supports dynamic variable substitution in job files. For example, with the following `agents.json`:

```json
[
  {
    "host": "192.168.1.110",
    "roles": ["OPENSEARCH", "LEADER"]
  },
  {
    "host": "192.168.1.119",
    "roles": ["OPENSEARCH"]
  },
  {
    "host": "192.168.1.134",
    "roles": ["OPENSEARCH"]
  }
]
```

**Maand** generates variables based on roles and attributes, which are used in job files with extensions such as `*.json`, `*.service`, `*.conf`, `*.yml`, `*.env`, and `*.token`.

**Example Variable Usage**

**`config.env`**

```shell
LEADER=$LEADER_0
LEADER_COUNT=$LEADER_LENGTH
OPENSEARCH1=$OPENSEARCH_1
```

**On the Agent**

```shell
$ cat /opt/agent/[bucket_guid]/jobs/sample_job/config.env
LEADER=0
LEADER_COUNT=1
OPENSEARCH1=192.168.1.119
```

```text
CLUSTER_ID=xxxxx-xxx-xxx-xxxx  # GUID
AGENT_ID=xxxxx-xxx-xxx-xxxx    # GUID
AGENT_IP=192.168.1.110
OPENSEARCH_ALLOCATION_INDEX=0
OPENSEARCH_1=192.168.1.110
OPENSEARCH_2=192.168.1.119
OPENSEARCH_3=192.168.1.134
OPENSEARCH_OTHERS=192.168.1.119,192.168.1.134
OPENSEARCH_NODES=192.168.1.110,192.168.1.119,192.168.1.134
OPENSEARCH_LENGTH=3
LEADER_ALLOCATION_INDEX=0
LEADER_1=192.168.1.110
LEADER_LENGTH=1
ROLES=opensearch,leader
## values from variables.env, secrets.env, and ports.env
```

**For `192.168.1.119`**

```text
CLUSTER_ID=xxxxx-xxx-xxx-xxxx  # GUID
AGENT_ID=xxxxx-xxx-xxx-xxxx    # GUID
AGENT_IP=192.168.1.119
OPENSEARCH_ALLOCATION_INDEX=1
OPENSEARCH_1=192.168.1.110
OPENSEARCH_2=192.168.1.119
OPENSEARCH_3=192.168.1.134
OPENSEARCH_OTHERS=192.168.1.110,192.168.1.134
OPENSEARCH_NODES=192.168.1.110,192.168.1.119,192.168.1.134
OPENSEARCH_LENGTH=3
LEADER_1=192.168.1.110
LEADER_LENGTH=1
ROLES=opensearch
## values from variables.env, secrets.env, and ports.env
```

**Note**: Variables are also available in `/opt/agent/[bucket_guid]/context.env`, but `secrets.env` is not included.

These dynamically generated variables enable **Maand** to handle complex orchestration scenarios effectively, using roles and attributes defined in `agents.json`.

### Executing Commands

The `command.sh` script in the workspace can be used for ad-hoc command execution.

- Running `maand run_command` executes `command.sh` on each agent after verifying cluster membership using `bucket_guid` between the agent and workspace.
- Running `maand run_command --no-check` executes `command.sh` on each agent without cluster validation.
- Running `maand run_command_local` executes `command.sh` locally on

 the **Maand** controller while validating cluster membership under agent context.
- Running `maand run_command_health_check` executes `command.sh` on each agent, performing health checks before execution.

The above commands supports roles and agents filters.

```shell
$ maand run_command --roles=role1,role2
$ maand run_command --agents=x.x.x.x,x.x.x.x
```

### Job Control

- Running `maand job start` executes `/opt/agent/[bucket_guid]/bin/runner.py`, which runs the `start` target from the `Makefile` of each job on the agent.
- Running `maand job stop` executes `/opt/agent/[bucket_guid]/bin/runner.py`, which runs the `stop` target from the `Makefile` of each job on the agent.
- Running `maand job restart` executes `/opt/agent/[bucket_guid]/bin/runner.py`, which runs the `restart` target from the `Makefile` of each job on the agent.
- Running `maand job rolling_restart` executes `/opt/agent/[bucket_guid]/bin/runner.py`, which runs the `restart` target from the `Makefile` of each job on the agent and runs health checks before and after per each agent.

The above commands supports jobs, order and agents filters.

```shell
$ maand job start --jobs=sample_job
$ maand job start --agents=x.x.x.x,x.x.x.x
```

** Disabled Jobs **

To disable jobs for specific agents or roles, use a `disabled.json` file in the workspace:

```json
{
  "jobs":{
    "job1": {}, # This disables a job
    "job2": {
      "agents": ["x.x.x.x"] # This disables a job at the particluar agent
    }
  },
  "agents": ["x.x.x.x"] # All jobs at the particluar agent are disabled
}
```

`maand update` apply changes

### Job command

Each job folder can include a `_modules` directory and can include job command in their.

### Health Check

Each job folder can include a `_modules` directory and a `run.sh` file. The `run.sh` file is executed with the agent context on the Maand controller node and should include health checks for the job. These health checks are also used for safe rolling restarts.

To perform a health check, use the following command:

```shell
make health_check
```
